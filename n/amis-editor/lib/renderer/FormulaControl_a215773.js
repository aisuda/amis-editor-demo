amis.define("238be83",(function(e,t,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=e("849c8c1"),o=e("cc4bbf0"),i=e("fe8d80a"),l=e("52cfd4c"),u=e("3638093"),d=e("a5f055b"),s=e("4930ed8"),p=e("a2c664a"),c=e("af1cc81"),m=e("167c905"),b=e("2b4d884"),f=e("8ba532b"),h=e("da84bac"),v=e("fb32b1a");function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var _,g=y(o),x=y(i),C=y(l),O=y(u),D=y(d),E=y(s),F=y(p),j=y(c);t.FormulaDateType=void 0,(_=t.FormulaDateType||(t.FormulaDateType={}))[_.NotDate=0]="NotDate",_[_.IsDate=1]="IsDate",_[_.IsRange=2]="IsRange";var w=function(e){function a(t){var a=e.call(this,t)||this;return Object.defineProperty(a,"isUnmount",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(a,"handleSimpleInputChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){var t,r,n=a.outReplaceExpression(e);null===(r=null===(t=a.props)||void 0===t?void 0:t.onChange)||void 0===r||r.call(t,n)}}),Object.defineProperty(a,"handleInputChange",{enumerable:!0,configurable:!0,writable:!0,value:function(e){var t,r;null===(r=null===(t=a.props)||void 0===t?void 0:t.onChange)||void 0===r||r.call(t,e)}}),a.state={variables:[],variableMode:"tabs"},a}return n.__extends(a,e),Object.defineProperty(a.prototype,"componentDidMount",{enumerable:!1,configurable:!0,writable:!0,value:function(){return n.__awaiter(this,void 0,void 0,(function(){var e;return n.__generator(this,(function(t){switch(t.label){case 0:return[4,h.getVariables(this)];case 1:return e=t.sent(),this.setState({variables:e}),[2]}}))}))}}),Object.defineProperty(a.prototype,"componentDidUpdate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return n.__awaiter(this,void 0,void 0,(function(){var t;return n.__generator(this,(function(a){switch(a.label){case 0:return this.props.data===e.data?[3,2]:[4,h.getVariables(this)];case 1:t=a.sent(),this.setState({variables:t}),a.label=2;case 2:return[2]}}))}))}}),Object.defineProperty(a.prototype,"componentWillUnmount",{enumerable:!1,configurable:!0,writable:!0,value:function(){this.isUnmount=!0}}),Object.defineProperty(a.prototype,"outReplaceExpression",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return e&&E.default(e)&&m.isExpression(e)?e.replace(/(^|[^\\])\$\{/g,"\\${"):e}}),Object.defineProperty(a.prototype,"inReplaceExpression",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return e&&E.default(e)?e.replace(/\\\$\{/g,"${"):e}}),Object.defineProperty(a.prototype,"isLoopExpression",{enumerable:!1,configurable:!0,writable:!0,value:function(e,t){if(!e||!t||!E.default(e))return!1;var a=[];try{a=m.FormulaExec.collect(e)}catch(e){}return a.some((function(e){return e===t}))}}),Object.defineProperty(a.prototype,"isExpectType",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(null==e)return!0;var t=this.props.rendererSchema,a=this.props.valueType;if(null==a)return!0;var r=this.getContextData();if("switch"===t.type&&(void 0!==t.trueValue||void 0!==t.falseValue))return t.trueValue===e||t.falseValue===e;if("number"===a&&x.default(e)||"boolean"===a&&C.default(e)||"object"===a&&O.default(e)||"array"===a&&D.default(e))return!0;if(E.default(e))if(m.isExpression(e)){var n=m.FormulaExec.formula(e,r);if("number"===a&&x.default(n)||"boolean"===a&&C.default(n)||"object"===a&&O.default(n)||"array"===a&&D.default(n)||"string"===a&&E.default(n))return!0}else if("string"===a)return!0;return!1}}),Object.defineProperty(a.prototype,"matchDate",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t=/^(.+)?(\+|-)(\d+)(minute|min|hour|day|week|month|year|weekday|second|millisecond)s?$/i.exec(e);return!!t&&(!t[1]||this.matchDate(t[1]))}}),Object.defineProperty(a.prototype,"matchDateRange",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return!!/^(now|today)$/.test(e)||this.matchDate(e)}}),Object.defineProperty(a.prototype,"hasDateShortcutkey",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var a,r=this.props.DateTimeType;if(r===t.FormulaDateType.IsDate)return!!/^(now|today)$/.test(e)||this.matchDate(e);if(r===t.FormulaDateType.IsRange){var n=null===(a=null==e?void 0:e.split)||void 0===a?void 0:a.call(e,",");if(n&&2===n.length)return this.matchDateRange(n[0].trim())&&this.matchDateRange(n[1].trim())}return!1}}),Object.defineProperty(a.prototype,"transExpr",{enumerable:!1,configurable:!0,writable:!0,value:function(e){return"string"==typeof e&&"${"===(null==e?void 0:e.slice(0,2))&&"}"===(null==e?void 0:e.slice(-1))?m.isExpression(e.slice(2,-1))||e.lastIndexOf("${")>e.indexOf("}")&&e.indexOf("}")>-1?e:e.slice(2,-1):e}}),Object.defineProperty(a.prototype,"handleConfirm",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,a,r=e?m.isExpression(e)||this.hasDateShortcutkey(e)?e:"${".concat(e,"}"):void 0;null===(a=null===(t=this.props)||void 0===t?void 0:t.onChange)||void 0===a||a.call(t,r)}}),Object.defineProperty(a.prototype,"filterCustomRendererProps",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t,a,r,n=this.props,o=n.data,i=n.name,l=n.placeholder,u=null;if(e){u=Object.assign({},e,o,{type:null!==(t=e.type)&&void 0!==t?t:o.type,name:null!==(r=null!==(a=e.name)&&void 0!==a?a:o.name)&&void 0!==r?r:"value"});var d=["label","id","$$id","className","style","readOnly","horizontal","size","remark","labelRemark","hidden","hiddenOn","visible","visibleOn","disabled","disabledOn","required","requiredOn","className","labelClassName","labelAlign","inputClassName","description","autoUpdate","prefix","suffix","unitOptions","keyboard","kilobitSeparator","value"];this.props.needDeleteProps&&d.push.apply(d,this.props.needDeleteProps),i&&"min"===i&&d.push("min"),i&&"max"===i&&d.push("max"),(u=F.default(u,d)).clearable=!0,"select"===u.type?(!u.placeholder&&(u.placeholder=v.i18n("8f7ae284d0039fe05b9f57fd5ae3ede9")),u.inputClassName="ae-editor-FormulaControl-select-style"):u.placeholder=l||v.i18n("e0c7ac5eb397512fdbe71600baa09dab"),u.popOverContainer=window.document.body}return u}}),Object.defineProperty(a.prototype,"renderFormulaValue",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var t={__html:e.html};return g.default.createElement("span",{dangerouslySetInnerHTML:t})}}),Object.defineProperty(a.prototype,"getContextData",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,a,r;return(null===(a=null===(t=null===(e=this.props.data)||void 0===e?void 0:e.__super)||void 0===t?void 0:t.__props__)||void 0===a?void 0:a.data)||(null===(r=this.props.manager)||void 0===r?void 0:r.amisStore)||{}}}),Object.defineProperty(a.prototype,"render",{enumerable:!1,configurable:!0,writable:!0,value:function(){var e,t,a=this,r=this.props,o=r.className;r.label;var i=r.value,l=r.header;r.variables;var u=r.placeholder,d=r.simple,s=r.rendererSchema,p=r.rendererWrapper,c=r.manager,f=r.useExternalFormData,h=void 0!==f&&f,y=r.render,_=n.__rest(r,["className","label","value","header","variables","placeholder","simple","rendererSchema","rendererWrapper","manager","useExternalFormData","render"]),x=null===(t=null===(e=this.props)||void 0===e?void 0:e.data)||void 0===t?void 0:t.name,C=m.isExpression(i),O=!1;C&&(null==s?void 0:s.name)&&(O=!!(null==s?void 0:s.name)&&this.isLoopExpression(i,null==s?void 0:s.name));var D=!this.isExpectType(i),E=this.transExpr(i),F=O||D,w=m.isExpression(i)?b.FormulaEditor.highlightValue(E,this.state.variables)||{html:E}:i,P=m.isExpression(i)?E:this.hasDateShortcutkey(i)?i:void 0,S=!d&&(C||this.hasDateShortcutkey(i));return g.default.createElement("div",{className:j.default("ae-editor-FormulaControl",F?"is-has-tooltip":"",o)},!d&&!C&&!this.hasDateShortcutkey(i)&&!s&&g.default.createElement(m.InputBox,{className:"ae-editor-FormulaControl-input",value:this.inReplaceExpression(i),clearable:!0,placeholder:null!=u?u:v.i18n("e0c7ac5eb397512fdbe71600baa09dab"),onChange:this.handleSimpleInputChange}),!d&&!C&&!this.hasDateShortcutkey(i)&&s&&g.default.createElement("div",{className:j.default("ae-editor-FormulaControl-custom-renderer",p?"border-wrapper":"")},y("inner",this.filterCustomRendererProps(s),{inputOnly:!0,value:this.inReplaceExpression(i),data:h?n.__assign({},this.props.data):{},onChange:this.handleSimpleInputChange,manager:c})),S&&g.default.createElement(m.TooltipWrapper,{trigger:"hover",placement:"top",style:{fontSize:"12px"},tooltip:{tooltipTheme:"dark",mouseLeaveDelay:20,content:E,children:function(){return a.renderFormulaValue(w)}}},g.default.createElement("div",{className:"ae-editor-FormulaControl-tooltipBox"},g.default.createElement(m.ResultBox,{className:j.default("ae-editor-FormulaControl-ResultBox",F?"is-error":""),allowInput:!1,clearable:!0,value:i,result:{html:this.hasDateShortcutkey(i)?v.i18n("48942ef507ea38d8ead03f8bfdffae5a"):v.i18n("0d9d899edb456e8806a99850e9c38212")},itemRender:this.renderFormulaValue,onChange:this.handleInputChange,onResultChange:function(){a.handleInputChange(void 0)}}))),g.default.createElement(m.PickerContainer,{showTitle:!1,bodyRender:function(e){var t;e.value;var r=e.onChange;return g.default.createElement(b.FormulaEditor,n.__assign({},_,{evalMode:!0,variableMode:null!==(t=_.variableMode)&&void 0!==t?t:a.state.variableMode,variables:a.state.variables,header:l||v.i18n("a9400c408441f1f7f6d6954deb05ae9a"),value:P,onChange:r,selfVariableName:x}))},value:i,onConfirm:this.handleConfirm,size:"md"},(function(e){var t,a=e.onClick;return g.default.createElement(m.Button,{className:"ae-editor-FormulaControl-button",size:"sm",tooltip:{enterable:!1,content:v.i18n("303efd5ba79e639001b4328cd266dddc"),placement:"left",mouseLeaveDelay:0},onClick:a},g.default.createElement(m.Icon,{icon:"function",className:j.default("ae-editor-FormulaControl-icon","icon",(t={},t["is-filled"]=!!S,t))}))})),F&&g.default.createElement("div",{className:"desc-msg error-msg"},O?v.i18n("7d92f998d24da41b58db140b1864f773"):v.i18n("b5cc1cd60cd694f45142dc52a5bf53fc")))}}),Object.defineProperty(a,"defaultProps",{enumerable:!0,configurable:!0,writable:!0,value:{simple:!1,rendererWrapper:!1,DateTimeType:t.FormulaDateType.NotDate,requiredDataPropsVariables:!1}}),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",Object)],a.prototype,"outReplaceExpression",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",Object)],a.prototype,"inReplaceExpression",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object,String]),n.__metadata("design:returntype",Boolean)],a.prototype,"isLoopExpression",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",Boolean)],a.prototype,"isExpectType",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[String]),n.__metadata("design:returntype",Boolean)],a.prototype,"hasDateShortcutkey",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[String]),n.__metadata("design:returntype",void 0)],a.prototype,"transExpr",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",void 0)],a.prototype,"handleConfirm",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",void 0)],a.prototype,"filterCustomRendererProps",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[Object]),n.__metadata("design:returntype",void 0)],a.prototype,"renderFormulaValue",null),n.__decorate([f.autobind,n.__metadata("design:type",Function),n.__metadata("design:paramtypes",[]),n.__metadata("design:returntype",void 0)],a.prototype,"getContextData",null),a}(g.default.Component);!function(e){function t(){return null!==e&&e.apply(this,arguments)||this}n.__extends(t,e),t=n.__decorate([m.FormItem({type:"ae-formulaControl"})],t)}(w),t.default=w}));